[![Create Release and ZIP](https://github.com/Bannercity-cl/teva-preguntas/actions/workflows/release.yml/badge.svg)](https://github.com/Bannercity-cl/teva-preguntas/actions/workflows/release.yml)

# TEVA Preguntas - Sistema de Encuestas por Email

Un plugin de WordPress para crear y gestionar encuestas interactivas enviadas por email con validaci√≥n de participantes mediante CSV y formularios de registro integrados.

## üöÄ Caracter√≠sticas

- **Gesti√≥n de Encuestas**: Crear preguntas con 3 opciones de respuesta
- **Validaci√≥n por CSV**: Importar lista de participantes v√°lidos desde archivo CSV
- **Sistema de Intentos**: M√°ximo 3 intentos por participante
- **Sesiones Seguras**: URLs con tokens para prevenir acceso no autorizado
- **Formulario de Registro**: Integraci√≥n con Fidelizador para captura de datos m√©dicos
- **Dashboard Administrativo**: Panel completo para gesti√≥n y estad√≠sticas
- **Gr√°ficos de Resultados**: Visualizaci√≥n de datos con gr√°ficos de torta
- **Responsive Design**: Optimizado para dispositivos m√≥viles

## üìã Requisitos

- WordPress 5.0 o superior
- PHP 8.1 o superior
- MySQL 8.0 o superior
- Permisos de administrador de WordPress

## üîß Instalaci√≥n

1. **Subir el Plugin**:
   ```bash
   # Copiar el archivo al directorio de plugins
   cp teva-preguntas.php /wp-content/plugins/
   ```

2. **Activar en WordPress**:
   - Ir a `Plugins > Plugins instalados`
   - Buscar "TEVA Preguntas"
   - Hacer clic en "Activar"

3. **Verificar Instalaci√≥n**:
   - El plugin crear√° autom√°ticamente las tablas necesarias
   - Aparecer√° "TEVA Preguntas" en el men√∫ de administraci√≥n

## üìä Estructura de Base de Datos

El plugin crea 4 tablas autom√°ticamente:

```sql
-- Encuestas/Preguntas
wp_email_surveys
- id, question, option1, option2, option3, correct_answer, is_active, created_at

-- Emails v√°lidos (participantes)
wp_survey_valid_emails  
- id, email, name, created_at

-- Votos/Respuestas
wp_survey_votes
- id, survey_id, email, selected_option, is_correct, voted_at

-- Sesiones de usuario
wp_survey_sessions
- token, survey_id, email, expires, created_at
```

## üéØ Uso

### 1. Crear una Pregunta

1. Ir a `TEVA Preguntas` en el admin de WordPress
2. Completar el formulario "Crear Nueva Pregunta":
   - **Pregunta**: El texto de la pregunta
   - **Opciones 1-3**: Las tres opciones de respuesta
   - **Respuesta Correcta**: Seleccionar cu√°l es la correcta
3. Hacer clic en "Crear Pregunta"

### 2. Subir Lista de Participantes

**Formato CSV soportado**:
```csv
email,nombre
doctor1@hospital.com,Dr. Juan P√©rez
doctora2@clinica.com,Dra. Mar√≠a Gonz√°lez
```

**O formato con punto y coma**:
```csv
"email";"estado";"fecha";"otros_campos";"nombre"
"doctor1@hospital.com";"activo";"2024-01-01";"campo";"Dr. Juan P√©rez"
```

1. Ir a "Subir Lista de Participantes (CSV)"
2. Seleccionar archivo CSV
3. Hacer clic en "Subir Lista CSV"

### 3. Generar URLs para Email

Despu√©s de crear una pregunta, el sistema genera URLs como:
```
https://tudominio.com/encuesta/?survey=1&email={EMAIL}&option=1
https://tudominio.com/encuesta/?survey=1&email={EMAIL}&option=2  
https://tudominio.com/encuesta/?survey=1&email={EMAIL}&option=3
```

**Reemplazar `{EMAIL}` con el email real del participante**.

### 4. Configurar P√°ginas de WordPress

Crear estas p√°ginas con los shortcodes correspondientes:

**P√°gina: `/encuesta/`**
```
[survey_form]
```

**P√°gina: `/resultados/`**
```
[survey_results]
```

## üîí Seguridad

- **Validaci√≥n de Email**: Solo participantes en el CSV pueden votar
- **Tokens de Sesi√≥n**: URLs seguras con expiraci√≥n de 24 horas
- **Protecci√≥n CSRF**: Nonces para todas las operaciones AJAX
- **L√≠mite de Intentos**: M√°ximo 3 intentos por participante
- **Sanitizaci√≥n**: Todos los inputs est√°n sanitizados

## üõ†Ô∏è Herramientas de Mantenimiento

En el panel de administraci√≥n hay opciones para:

- **üó≥Ô∏è Limpiar Solo Respuestas**: Elimina todos los votos
- **üìß Limpiar Solo Participantes**: Elimina la lista de emails
- **üìã Limpiar Solo Preguntas**: Elimina todas las preguntas
- **üö® RESET COMPLETO**: Reinicia todo el plugin

## üì± Shortcodes Disponibles

### `[survey_form]`
Muestra el formulario de encuesta. Maneja autom√°ticamente:
- Validaci√≥n de sesi√≥n
- Control de intentos
- Redirecci√≥n a resultados

### `[survey_results]`
Muestra los resultados de la encuesta:
- Formulario m√©dico (si respondi√≥ correctamente)
- Gr√°fico de estad√≠sticas (si respondi√≥ incorrectamente)
- Opci√≥n de reintentar (si tiene intentos restantes)

## üé® Personalizaci√≥n CSS

El plugin incluye estilos completos, pero puedes personalizar:

```css
/* Personalizar colores del formulario */
.survey-option.selected {
    border-color: #tu-color !important;
    background: #tu-fondo !important;
}

/* Personalizar bot√≥n de env√≠o */
.survey-submit-btn {
    background: linear-gradient(135deg, #tu-color1, #tu-color2) !important;
}
```

## üîÑ Flujo de Usuario

1. **Email Inicial**: Usuario recibe email con botones/enlaces
2. **Validaci√≥n**: Sistema verifica email en lista de participantes
3. **Sesi√≥n Segura**: Se crea token de sesi√≥n y redirecci√≥n limpia
4. **Formulario**: Usuario ve pregunta y selecciona respuesta
5. **Resultados**: 
   - ‚úÖ **Correcto**: Formulario de registro m√©dico
   - ‚ùå **Incorrecto**: Estad√≠sticas + opci√≥n de reintentar

## üêõ Troubleshooting

### Problema: "Email no autorizado"
- **Soluci√≥n**: Verificar que el email est√© en el archivo CSV subido

### Problema: "Sesi√≥n inv√°lida o expirada"
- **Soluci√≥n**: Usar el enlace original del email (las sesiones duran 24h)

### Problema: No se muestran las p√°ginas
- **Soluci√≥n**: Verificar que las p√°ginas `/encuesta/` y `/resultados/` existan con los shortcodes correctos

### Problema: Error en la base de datos
- **Soluci√≥n**: Usar la herramienta "RESET COMPLETO" en el admin

## üìù Logs de Debug

Para activar logs detallados, agregar en `wp-config.php`:
```php
define('WP_DEBUG', true);
define('WP_DEBUG_LOG', true);
```

Los logs se guardan en `/wp-content/debug.log`

## üîß Configuraci√≥n Avanzada

### Cambiar l√≠mite de intentos
En `teva-preguntas.php`, l√≠nea ~1240:
```php
$max_attempts = 3; // Cambiar a tu valor deseado
```

### Cambiar duraci√≥n de sesi√≥n
En `create_session_token()`, l√≠nea ~1970:
```php
'expires' => time() + (24 * 60 * 60) // 24 horas, cambiar seg√∫n necesites
```

## üö´ Desinstalaci√≥n

**‚ö†Ô∏è ADVERTENCIA**: Esto eliminar√° TODOS los datos del plugin.

1. Desactivar el plugin en WordPress
2. Eliminar el plugin desde `Plugins > Plugins instalados`
3. El hook de desinstalaci√≥n limpiar√° autom√°ticamente:
   - Todas las tablas
   - Todas las opciones
   - Todos los transients
   
---

**‚ö° Desarrollado con WordPress + PHP + MySQL + JavaScript**
